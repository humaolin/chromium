name: Build ungoogled-chromium (arm64, self-hosted)

on:
  workflow_dispatch:

jobs:
  build_ungoogled:
    # 强烈建议在自托管 aarch64 runner（Debian Buster）上运行
    runs-on: [self-hosted, linux, arm64]
    env:
      SRC_DIR: build/src
      OUTDIR: build/src/out/Default
      DOWNLOAD_CACHE: build/download_cache
      UNGOOGLED_DIR: ungoogled   # 你仓库中放 ungoogled-chromium 的文件夹（downloads.ini, patches, pruning.list, domain_substitution.list 等）
      NINJA_JOBS: 4              # 根据内存 / 核心调整（若内存小，设置为 1-2）
      USE_SWAP: "true"          # "true" or "false"
      SWAP_SIZE_GB: 16          # 例如 16（按需调整）
      TAR_NAME: ungoogled-chromium-arm64-${{ github.run_number }}.tar.xz

    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install base packages (Debian-based)
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv git curl ca-certificates \
            build-essential pkg-config clang cmake ninja-build gnupg python3-setuptools \
            libgtk-3-dev libnss3-dev libcups2-dev xz-utils debootstrap
          # 根据平台补其他依赖

      - name: Prepare depot_tools and ensure cipd
        run: |
          DT="$RUNNER_TEMP/depot_tools"
          rm -rf "$DT"
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$DT"
          chmod -R a+x "$DT" || true
          echo "$DT" >> $GITHUB_PATH
          # 尝试 update_depot_tools
          if [ -x "$DT/update_depot_tools" ]; then
            "$DT/update_depot_tools" || true
          fi
          if ! command -v cipd >/dev/null 2>&1; then
            echo "cipd missing, try direct download"
            mkdir -p "$RUNNER_TEMP/bin"
            ARCH="$(uname -m)"
            if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
              CIPD_TARGET="linux-arm64"
            else
              CIPD_TARGET="linux-amd64"
            fi
            curl -fsSL "https://chrome-infra-packages.appspot.com/dl/infra/tools/cipd/${CIPD_TARGET}/latest" -o "$RUNNER_TEMP/bin/cipd"
            chmod +x "$RUNNER_TEMP/bin/cipd"
            echo "$RUNNER_TEMP/bin" >> $GITHUB_PATH
          fi
          which cipd || (echo "cipd still missing" && exit 1)
          cipd --version || true

      - name: Prepare directories and download cache
        run: |
          mkdir -p ${{ env.DOWNLOAD_CACHE }}
          mkdir -p ${{ env.SRC_DIR }}

      - name: Retrieve downloads (download cache) for ungoogled-chromium
        run: |
          # 假设 ungoogled repo files 在 $UNGOOGLED_DIR 下
          cd ${{ env.UNGOOGLED_DIR }}
          python3 ./utils/downloads.py retrieve -c ../${{ env.DOWNLOAD_CACHE }} -i downloads.ini
          python3 ./utils/downloads.py unpack -c ../${{ env.DOWNLOAD_CACHE }} -i downloads.ini -- ../${{ env.SRC_DIR }}
        working-directory: ${{ github.workspace }}/${{ env.UNGOOGLED_DIR }}

      - name: Prune binaries
        run: |
          cd ${{ env.SRC_DIR }}
          python3 ../${{ env.UNGOOGLED_DIR }}/utils/prune_binaries.py . ../${{ env.UNGOOGLED_DIR }}/pruning.list
        working-directory: ${{ github.workspace }}

      - name: Apply patches (ungoogled)
        run: |
          cd ${{ env.SRC_DIR }}
          python3 ../${{ env.UNGOOGLED_DIR }}/utils/patches.py apply . ../${{ env.UNGOOGLED_DIR }}/patches
        working-directory: ${{ github.workspace }}

      - name: Domain substitution (optional)
        run: |
          cd ${{ env.SRC_DIR }}
          python3 ../${{ env.UNGOOGLED_DIR }}/utils/domain_substitution.py apply -r ../${{ env.UNGOOGLED_DIR }}/domain_regex.list -f ../${{ env.UNGOOGLED_DIR }}/domain_substitution.list -c ../${{ env.DOWNLOAD_CACHE }}/domsubcache.tar.gz .
        working-directory: ${{ github.workspace }}

      - name: GN bootstrap (if you don't have gn)
        run: |
          cd ${{ env.SRC_DIR }}
          python3 ./tools/gn/bootstrap/bootstrap.py --skip-generate-buildfiles -j4 -o out/Default/ || true
        working-directory: ${{ github.workspace }}

      - name: Prepare flags.gn (你可以把自定义 flags.gn 放仓库里然后复制)
        run: |
          mkdir -p ${{ env.OUTDIR }}
          # 如果你在仓库中有 flags.gn，可以复制到 out/Default/args.gn
          if [ -f "${{ env.UNGOOGLED_DIR }}/flags.gn" ]; then
            cp "${{ env.UNGOOGLED_DIR }}/flags.gn" "${{ env.OUTDIR }}/args.gn"
          else
            cat > "${{ env.OUTDIR }}/args.gn" <<'EOF'
            is_debug = false
            target_cpu = "arm64"
            symbol_level = 0
            blink_symbol_level = 0
            is_component_build = false
            EOF
          fi

      - name: Optionally create swap (if memory low)
        if: ${{ env.USE_SWAP == 'true' }}
        run: |
          # 仅在 self-hosted 上运行：为避免 OOM，创建 swapfile（注意：检查磁盘空间）
          set -eux
          SWAP_GB=${{ env.SWAP_SIZE_GB }}
          SWAP_FILE=/swapfile_github_actions
          if [ ! -f "$SWAP_FILE" ]; then
            sudo fallocate -l ${SWAP_GB}G $SWAP_FILE
            sudo chmod 600 $SWAP_FILE
            sudo mkswap $SWAP_FILE
            sudo swapon $SWAP_FILE
            echo "Swapfile created and enabled: $SWAP_FILE ${SWAP_GB}G"
          else
            echo "Swapfile already exists"
          fi
          free -h

      - name: GN gen and build (ninja)
        run: |
          set -eux
          cd ${{ env.SRC_DIR }}
          # 确保 args.gn 存在（上一步已处理）
          ./out/Default/gn gen out/Default --fail-on-unused-args
          # 使用 NINJA_JOBS 控制并发，内存小就减小它
          ninja -C out/Default -j${{ env.NINJA_JOBS }} chrome chromedriver chrome_sandbox || (echo "build failed"; exit 1)
        working-directory: ${{ github.workspace }}

      - name: Pack build artifacts
        run: |
          set -eux
          cd ${{ env.SRC_DIR }}
          TAR_PATH="$GITHUB_WORKSPACE/${{ env.TAR_NAME }}"
          # 选择性打包 chrome 可执行与 lib 以及必要资源，避免打包整个 out 目录
          # 下面是示例，按实际文件位置调整
          tar -cJf "$TAR_PATH" -C out/Default chrome chrome_sandbox chromedriver || \
            ( echo "pack fallback: pack entire out/Default (may be large)"; tar -cJf "$TAR_PATH" -C out/Default . )
          ls -lh "$TAR_PATH"
          echo "TAR=$TAR_PATH" >> $GITHUB_OUTPUT

      - name: Create GitHub release & upload artifact
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}-ungoogled-arm64
          name: ungoogled-chromium-arm64-${{ github.run_number }}
          body: "ungoogled-chromium (arm64) build - automated"
          files: ${{ steps.pack_build_artifacts.outputs.TAR || env.GITHUB_WORKSPACE }}/{{ env.TAR_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
