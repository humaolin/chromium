
name: cross-build-chromium-arm64-glibc2.28

on:
  workflow_dispatch:

jobs:
  cross_build:
    runs-on: ubuntu-22.04
    env:
      DEPOT_TOOLS: $RUNNER_TEMP/depot_tools
      OUTDIR: out/arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install minimal deps
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip git curl ca-certificates unzip xz-utils

      - name: Get depot_tools and add to PATH
        run: |
          rm -rf "$DEPOT_TOOLS"
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$DEPOT_TOOLS"
          echo "$DEPOT_TOOLS" >> $GITHUB_PATH
          # ensure scripts are executable
          chmod -R a+x "$DEPOT_TOOLS"
      - name: Bootstrap depot_tools (install cipd / vpython / helpers)
        run: |
          # 有时 update_depot_tools 会在不同分支名称下存在，尝试几种常见方式去触发 bootstrapping
          if [ -x "$DEPOT_TOOLS/update_depot_tools" ]; then
            "$DEPOT_TOOLS/update_depot_tools" || true
          fi
          # some depot_tools versions use update_depot_tools.py
          if [ -f "$DEPOT_TOOLS/update_depot_tools.py" ]; then
            python3 "$DEPOT_TOOLS/update_depot_tools.py" || true
          fi
          # 确认 cipd 是否可用
          if ! command -v cipd >/dev/null 2>&1; then
            echo "cipd not found after bootstrap; will try fallback direct download"
          else
            echo "cipd found: $(command -v cipd)"
          fi

      - name: Fallback: download cipd binary if still missing
        if: ${{ ! (contains(env.PATH, 'cipd') || success()) && always() }}
        run: |
          # Detect linux-amd64 or linux-arm64 as needed; here runner is x86_64 (ubuntu-22.04)
          CIPD_URL="https://chrome-infra-packages.appspot.com/dl/infra/tools/cipd/linux-amd64/latest"
          CIPD_BIN="$RUNNER_TEMP/cipd"
          if ! command -v cipd >/dev/null 2>&1; then
            echo "Downloading cipd from $CIPD_URL"
            curl -fsSL -o "$CIPD_BIN" "$CIPD_URL"
            chmod +x "$CIPD_BIN"
            mkdir -p "$RUNNER_TEMP/bin"
            mv "$CIPD_BIN" "$RUNNER_TEMP/bin/cipd"
            echo "$RUNNER_TEMP/bin" >> $GITHUB_PATH
            echo "cipd installed at $RUNNER_TEMP/bin/cipd"
          else
            echo "cipd is already present"
          fi

      - name: Verify cipd available
        run: |
          echo "PATH=$PATH"
          which cipd || { echo "ERROR: cipd still not found"; exit 1; }
          cipd --version || echo "cipd --version failed (but tool exists)"

      - name: Fetch chromium (now cipd is in PATH)
        run: |
          # fetch command requires depot_tools in PATH (we added it via GITHUB_PATH above)
          fetch --nohooks chromium
          cd src
          gclient sync --with_branch_heads --no-history
        working-directory: ${{ github.workspace }}

      # ... 下面仍然是你以前的构建步骤（install-sysroot, gn gen, build 等）...
      - name: Pack artifact
        if: always()
        run: |
          # 仅示例：假设构建成功并且在 src/${OUTDIR} 下有输出，打包为单文件供上传
          cd src/${{ env.OUTDIR }} || exit 0
          tar -cJf $GITHUB_WORKSPACE/chromium-arm64-glibc2.28.tar.xz . || true

      - name: Create release (softprops)
        if: always()
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}-chromium-arm64
          name: chromium-arm64
          files: |
            $GITHUB_WORKSPACE/chromium-arm64-glibc2.28.tar.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
